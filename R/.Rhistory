library(readxl)
AransasBay_Sciaenid_Wide_Trans <- read_excel("~/Documents/GitHub/GEI-Texas-Bays/Input/AransasBay_Sciaenid_Wide_Trans.xlsx")
View(AransasBay_Sciaenid_Wide_Trans)
library(dsem)
library(ggplot2)
library(ggpubr)
library(ggraph)
library(phylopath)
library(dplyr)
library(ggdag)
library(readxl)
library(ggraph)
library(qgraph)
library(DHARMa)
# get data into a time series object from all numeric columns except YEAR
AB_Sciaenid_TS <- ts(
AransasBay_Sciaenid_Wide_Trans %>%
select(-YEAR),
start = c(min(AransasBay_Sciaenid_Wide_Trans$YEAR)),
end = c(max(AransasBay_Sciaenid_Wide_Trans$YEAR)),
frequency = 1  # assuming yearly data
)
sem1 <- "
BlueCrabSmall_AransasBay -> RedDrum_AransasBay, 0, a
Temperature_AransasBay -> RedDrum_AransasBay, 0, b
Temperature_AransasBay -> BlueCrabSmall_AransasBay, 0, c
BlueCrabSmall_AransasBay -> BlackDrum_AransasBay, 0, d
Temperature_AransasBay -> BlackDrum_AransasBay, 0, e
BlueCrabSmall_AransasBay -> SpottedSeatrout_AransasBay, 0, f
Temperature_AransasBay -> SpottedSeatrout_AransasBay, 0, g
BlueCrabSmall_AransasBay -> HardheadCatfish_AransasBay, 0, h
Temperature_AransasBay -> HardheadCatfish_AransasBay, 0, i
BlueCrabSmall_AransasBay -> GafftopsailCatfish_AransasBay, 0, j
Temperature_AransasBay -> GafftopsailCatfish_AransasBay, 0, k
BrownShrimp_AransasBay -> RedDrum_AransasBay, 0, l
Temperature_AransasBay -> BrownShrimp_AransasBay, 0, m
BrownShrimp_AransasBay -> BlackDrum_AransasBay, 0, n
BrownShrimp_AransasBay -> SpottedSeatrout_AransasBay, 0, o
BrownShrimp_AransasBay -> HardheadCatfish_AransasBay, 0, p
BrownShrimp_AransasBay -> GafftopsailCatfish_AransasBay, 0, q
Salinity_AransasBay -> RedDrum_AransasBay, 0, r
Salinity_AransasBay -> BlueCrabSmall_AransasBay, 0, s
Salinity_AransasBay -> BlackDrum_AransasBay, 0, t
Salinity_AransasBay -> SpottedSeatrout_AransasBay, 0, u
Salinity_AransasBay -> HardheadCatfish_AransasBay, 0, v
Salinity_AransasBay -> GafftopsailCatfish_AransasBay, 0, w
Salinity_AransasBay -> BrownShrimp_AransasBay, 0, x
BlueCrabSmall_AransasBay -> RedDrum_AransasBay, 1, aa
Temperature_AransasBay -> RedDrum_AransasBay, 1, bb
Temperature_AransasBay -> BlueCrabSmall_AransasBay, 1, cc
BlueCrabSmall_AransasBay -> BlueCrabSmall_AransasBay, 1, dd
RedDrum_AransasBay -> RedDrum_AransasBay, 1, ee
BlueCrabSmall_AransasBay -> BlackDrum_AransasBay, 1, ff
Temperature_AransasBay -> BlackDrum_AransasBay, 1, gg
BlackDrum_AransasBay -> BlackDrum_AransasBay, 1, hh
BlueCrabSmall_AransasBay -> SpottedSeatrout_AransasBay, 1, ii
Temperature_AransasBay -> SpottedSeatrout_AransasBay, 1, jj
SpottedSeatrout_AransasBay -> SpottedSeatrout_AransasBay, 1, kk
BlueCrabSmall_AransasBay -> HardheadCatfish_AransasBay, 1, ll
Temperature_AransasBay -> HardheadCatfish_AransasBay, 1, mm
HardheadCatfish_AransasBay -> HardheadCatfish_AransasBay, 1, nn
BlueCrabSmall_AransasBay -> GafftopsailCatfish_AransasBay, 1, oo
Temperature_AransasBay -> GafftopsailCatfish_AransasBay, 1, pp
GafftopsailCatfish_AransasBay -> GafftopsailCatfish_AransasBay, 1, qq
BrownShrimp_AransasBay -> RedDrum_AransasBay, 1, rr
Temperature_AransasBay -> BrownShrimp_AransasBay, 1, ss
BrownShrimp_AransasBay -> BrownShrimp_AransasBay, 1, tt
BrownShrimp_AransasBay -> BlackDrum_AransasBay, 1, uu
BrownShrimp_AransasBay -> SpottedSeatrout_AransasBay, 1, vv
BrownShrimp_AransasBay -> HardheadCatfish_AransasBay, 1, ww
BrownShrimp_AransasBay -> GafftopsailCatfish_AransasBay, 1, xx
Salinity_AransasBay -> RedDrum_AransasBay, 1, yy
Salinity_AransasBay -> BlueCrabSmall_AransasBay, 1, zz
Salinity_AransasBay -> BlackDrum_AransasBay, 1, aaa
Salinity_AransasBay -> SpottedSeatrout_AransasBay, 1, bbb
Salinity_AransasBay -> HardheadCatfish_AransasBay, 1, ccc
Salinity_AransasBay -> GafftopsailCatfish_AransasBay, 1, ddd
Salinity_AransasBay -> BrownShrimp_AransasBay, 1, eee
BlueCrabSmall_CopanoBay -> RedDrum_CopanoBay, 0, abcd
Temperature_CopanoBay -> RedDrum_CopanoBay, 0, efgh
Temperature_CopanoBay -> BlueCrabSmall_CopanoBay, 0, ijkl
BlueCrabSmall_CopanoBay -> BlackDrum_CopanoBay, 0, mnop
Temperature_CopanoBay -> BlackDrum_CopanoBay, 0, qrst
BlueCrabSmall_CopanoBay -> SpottedSeatrout_CopanoBay, 0, uvwx
Temperature_CopanoBay -> SpottedSeatrout_CopanoBay, 0, yzab
BlueCrabSmall_CopanoBay -> HardheadCatfish_CopanoBay, 0, cdef
Temperature_CopanoBay -> HardheadCatfish_CopanoBay, 0, ghij
BlueCrabSmall_CopanoBay -> GafftopsailCatfish_CopanoBay, 0, klmn
Temperature_CopanoBay -> GafftopsailCatfish_CopanoBay, 0, opqr
BrownShrimp_CopanoBay -> RedDrum_CopanoBay, 0, stuv
Temperature_CopanoBay -> BrownShrimp_CopanoBay, 0, wxyz
BrownShrimp_CopanoBay -> BlackDrum_CopanoBay, 0, abcd
BrownShrimp_CopanoBay -> SpottedSeatrout_CopanoBay, 0, efgh
BrownShrimp_CopanoBay -> HardheadCatfish_CopanoBay, 0, ijkl
BrownShrimp_CopanoBay -> GafftopsailCatfish_CopanoBay, 0, mnop
Salinity_CopanoBay -> RedDrum_CopanoBay, 0, qrst
Salinity_CopanoBay -> BlueCrabSmall_CopanoBay, 0, uvwx
Salinity_CopanoBay -> BlackDrum_CopanoBay, 0, yzab
Salinity_CopanoBay -> SpottedSeatrout_CopanoBay, 0, cdef
Salinity_CopanoBay -> HardheadCatfish_CopanoBay, 0, ghij
Salinity_CopanoBay -> GafftopsailCatfish_CopanoBay, 0, klmn
Salinity_CopanoBay -> BrownShrimp_CopanoBay, 0, opqr
BlueCrabSmall_CopanoBay -> RedDrum_CopanoBay, 1, stuv
Temperature_CopanoBay -> RedDrum_CopanoBay, 1, wxyz
Temperature_CopanoBay -> BlueCrabSmall_CopanoBay, 1, abcd
BlueCrabSmall_CopanoBay -> BlueCrabSmall_CopanoBay, 1, efgh
RedDrum_CopanoBay -> RedDrum_CopanoBay, 1, ijkl
BlueCrabSmall_CopanoBay -> BlackDrum_CopanoBay, 1, mnop
Temperature_CopanoBay -> BlackDrum_CopanoBay, 1, qrst
BlackDrum_CopanoBay -> BlackDrum_CopanoBay, 1, uvwx
BlueCrabSmall_CopanoBay -> SpottedSeatrout_CopanoBay, 1, yzab
Temperature_CopanoBay -> SpottedSeatrout_CopanoBay, 1, cdef
SpottedSeatrout_CopanoBay -> SpottedSeatrout_CopanoBay, 1, ghij
BlueCrabSmall_CopanoBay -> HardheadCatfish_CopanoBay, 1, klmn
Temperature_CopanoBay -> HardheadCatfish_CopanoBay, 1, opqr
HardheadCatfish_CopanoBay -> HardheadCatfish_CopanoBay, 1, stuv
BlueCrabSmall_CopanoBay -> GafftopsailCatfish_CopanoBay, 1, wxyz
Temperature_CopanoBay -> GafftopsailCatfish_CopanoBay, 1, abcd
GafftopsailCatfish_CopanoBay -> GafftopsailCatfish_CopanoBay, 1, efgh
BrownShrimp_CopanoBay -> RedDrum_CopanoBay, 1, ijkl
Temperature_CopanoBay -> BrownShrimp_CopanoBay, 1, mnop
BrownShrimp_CopanoBay -> BrownShrimp_CopanoBay, 1, qrst
BrownShrimp_CopanoBay -> BlackDrum_CopanoBay, 1, uvwx
BrownShrimp_CopanoBay -> SpottedSeatrout_CopanoBay, 1, yzab
BrownShrimp_CopanoBay -> HardheadCatfish_CopanoBay, 1, cdef
BrownShrimp_CopanoBay -> GafftopsailCatfish_CopanoBay, 1, ghij
Salinity_CopanoBay -> RedDrum_CopanoBay, 1, klmn
Salinity_CopanoBay -> BlueCrabSmall_CopanoBay, 1, opqr
Salinity_CopanoBay -> BlackDrum_CopanoBay, 1, stuv
Salinity_CopanoBay -> SpottedSeatrout_CopanoBay, 1, wxyz
Salinity_CopanoBay -> HardheadCatfish_CopanoBay, 1, abcd
Salinity_CopanoBay -> GafftopsailCatfish_CopanoBay, 1, efgh
Salinity_CopanoBay -> BrownShrimp_CopanoBay, 1, ijkl
BlueCrabSmall_MesquiteBay -> RedDrum_MesquiteBay, 0, abcde
Temperature_MesquiteBay -> RedDrum_MesquiteBay, 0, fghij
Temperature_MesquiteBay -> BlueCrabSmall_MesquiteBay, 0, klmno
BlueCrabSmall_MesquiteBay -> BlackDrum_MesquiteBay, 0, pqrst
Temperature_MesquiteBay -> BlackDrum_MesquiteBay, 0, uvwxy
BlueCrabSmall_MesquiteBay -> SpottedSeatrout_MesquiteBay, 0, zabcd
Temperature_MesquiteBay -> SpottedSeatrout_MesquiteBay, 0, efghi
BlueCrabSmall_MesquiteBay -> HardheadCatfish_MesquiteBay, 0, jklmn
Temperature_MesquiteBay -> HardheadCatfish_MesquiteBay, 0, opqrs
BlueCrabSmall_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 0, tuvwz
Temperature_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 0, abcdf
BrownShrimp_MesquiteBay -> RedDrum_MesquiteBay, 0, ghijk
Temperature_MesquiteBay -> BrownShrimp_MesquiteBay, 0, lmnop
BrownShrimp_MesquiteBay -> BlackDrum_MesquiteBay, 0, qrstu
BrownShrimp_MesquiteBay -> SpottedSeatrout_MesquiteBay, 0, vwxyz
BrownShrimp_MesquiteBay -> HardheadCatfish_MesquiteBay, 0, abcde
BrownShrimp_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 0, fghij
Salinity_MesquiteBay -> RedDrum_MesquiteBay, 0, klmno
Salinity_MesquiteBay -> BlueCrabSmall_MesquiteBay, 0, pqrst
Salinity_MesquiteBay -> BlackDrum_MesquiteBay, 0, uvwxy
Salinity_MesquiteBay -> SpottedSeatrout_MesquiteBay, 0, zabcd
Salinity_MesquiteBay -> HardheadCatfish_MesquiteBay, 0, efghi
Salinity_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 0, jklmn
Salinity_MesquiteBay -> BrownShrimp_MesquiteBay, 0, opqrs
BlueCrabSmall_MesquiteBay -> RedDrum_MesquiteBay, 1, tuvwz
Temperature_MesquiteBay -> RedDrum_MesquiteBay, 1, abcdf
Temperature_MesquiteBay -> BlueCrabSmall_MesquiteBay, 1, ghijk
BlueCrabSmall_MesquiteBay -> BlueCrabSmall_MesquiteBay, 1, lmnop
RedDrum_MesquiteBay -> RedDrum_MesquiteBay, 1, qrstu
BlueCrabSmall_MesquiteBay -> BlackDrum_MesquiteBay, 1, vwxyz
Temperature_MesquiteBay -> BlackDrum_MesquiteBay, 1, abcde
BlackDrum_MesquiteBay -> BlackDrum_MesquiteBay, 1, fghij
BlueCrabSmall_MesquiteBay -> SpottedSeatrout_MesquiteBay, 1, klmno
Temperature_MesquiteBay -> SpottedSeatrout_MesquiteBay, 1, pqrst
SpottedSeatrout_MesquiteBay -> SpottedSeatrout_MesquiteBay, 1, uvwxy
BlueCrabSmall_MesquiteBay -> HardheadCatfish_MesquiteBay, 1, zabcd
Temperature_MesquiteBay -> HardheadCatfish_MesquiteBay, 1, efghi
HardheadCatfish_MesquiteBay -> HardheadCatfish_MesquiteBay, 1, jklmn
BlueCrabSmall_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 1, opqrs
Temperature_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 1, tuvwz
GafftopsailCatfish_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 1, abcdf
BrownShrimp_MesquiteBay -> RedDrum_MesquiteBay, 1, ghijk
Temperature_MesquiteBay -> BrownShrimp_MesquiteBay, 1, lmnop
BrownShrimp_MesquiteBay -> BrownShrimp_MesquiteBay, 1, qrstu
BrownShrimp_MesquiteBay -> BlackDrum_MesquiteBay, 1, vwxyz
BrownShrimp_MesquiteBay -> SpottedSeatrout_MesquiteBay, 1, abcde
BrownShrimp_MesquiteBay -> HardheadCatfish_MesquiteBay, 1, fghij
BrownShrimp_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 1, klmno
Salinity_MesquiteBay -> RedDrum_MesquiteBay, 1, pqrst
Salinity_MesquiteBay -> BlueCrabSmall_MesquiteBay, 1, uvwxy
Salinity_MesquiteBay -> BlackDrum_MesquiteBay, 1, zabcd
Salinity_MesquiteBay -> SpottedSeatrout_MesquiteBay, 1, efghi
Salinity_MesquiteBay -> HardheadCatfish_MesquiteBay, 1, jklmn
Salinity_MesquiteBay -> GafftopsailCatfish_MesquiteBay, 1, opqrs
Salinity_MesquiteBay -> BrownShrimp_MesquiteBay, 1, tuvwz
"
# fit the dsem model for the sciaenid system for aransas bay
fitAB = dsem( sem = sem1,
tsdata = AB_Sciaenid_TS,
family = rep("fixed", ncol(AB_Sciaenid_TS)),
estimate_delta0 = TRUE,
control = dsem_control(
quiet = TRUE))
summary(fitAB)
get_part = function(x){
vars = c("Salinity","BrownShrimp","GafftopsailCatfish","HardheadCatfish","SpottedSeatrout","Temperature","BlackDrum","RedDrum", "BlueCrabSmall")
index = sapply( vars, FUN=\(y) grep(y,rownames(x$coef))[1] )
x$coef = x$coef[index,index]
dimnames(x$coef) = list( vars, vars )
return(x)
}
# extract model fit values for and set up path diagrams
p1 = plot( get_part(as_fitted_DAG(fitAB)), type="width", show.legend=FALSE)
p1$layers[[1]]$mapping$edge_width = 0.9
p2 = plot( get_part(as_fitted_DAG(fitAB, what="p_value" )), type="width",
show.legend=FALSE, colors=c('black', 'black'))
p2$layers[[1]]$mapping$edge_width = 0.1
# arranging  path diagrams of coefficients and p values
ggarrange(p1 + scale_x_continuous(expand = c(0.3, 0)),
p2 + scale_x_continuous(expand = c(0.3, 0)),
labels = c("Simultaneous effects", "Two-sided p-value"),
ncol = 1, nrow = 2)
library(readxl)
AransasBay_BS_bluecrabs <- read_excel("~/Documents/GitHub/GEI-Texas-Bays/Input/AransasBay_BS_bluecrabs.xlsx")
View(AransasBay_BS_bluecrabs)
library(readxl)
AransasBay_BS_shrimp <- read_excel("~/Documents/GitHub/GEI-Texas-Bays/Input/AransasBay_BS_shrimp.xlsx")
View(AransasBay_BS_shrimp)
library(readxl)
AransasBay_BT <- read_excel("~/Documents/GitHub/GEI-Texas-Bays/Input/AransasBay_BT.xlsx")
View(AransasBay_BT)
library(readxl)
AransasBay_GN_cpue <- read_excel("~/Documents/GitHub/GEI-Texas-Bays/Input/AransasBay_GN_cpue.xlsx")
View(AransasBay_GN_cpue)
library(dplyr)
library(tidyr)
# merging temp and salinity data from three surveys
AransasBay_Abiotics <- bind_rows(
AransasBay_BS_shrimp %>%
select(MINOR_AREA_CODE, STATION_CODE, START_TEMPERATURE_NUM, START_SALINITY_NUM, DATE),
AransasBay_GN_cpue %>%
select(MINOR_AREA_CODE, STATION_CODE, START_TEMPERATURE_NUM, START_SALINITY_NUM, DATE),
AransasBay_BT %>%
select(MINOR_AREA_CODE, STATION_CODE, START_TEMPERATURE_NUM, START_SALINITY_NUM, DATE)
)
processforDSEM <- function(data, species, minor_area_mapping, date_column, result_df) {
# Step 1: Assign values to the new column MINOR_BAY based on MINOR_AREA_CODE
data <- data %>%
mutate(MINOR_BAY = case_when(
MINOR_AREA_CODE %in% minor_area_mapping$Copano_Bay ~ "Copano Bay",
MINOR_AREA_CODE %in% minor_area_mapping$Aransas_Bay ~ "Aransas Bay",
MINOR_AREA_CODE %in% minor_area_mapping$Mesquite_Bay ~ "Mesquite Bay",
TRUE ~ NA_character_
))
# Step 2: Extract YEAR from the specified date column
data$YEAR <- substr(data[[date_column]], 1, 4)
# Step 3: Calculate the mean value of each species per YEAR and MINOR_BAY
wide_data <- data %>%
group_by(YEAR, MINOR_BAY) %>%
summarize(across(all_of(species), ~ mean(.x, na.rm = TRUE), .names = "{.col}"), .groups = "drop") %>%
pivot_wider(
names_from = MINOR_BAY,
values_from = all_of(species),
names_glue = "{.value}_{MINOR_BAY}"  # Ensure consistent naming: species_minor_bay
)
# Step 4: Merge the output with the existing result dataframe
result_df <- result_df %>%
full_join(wide_data, by = "YEAR")
return(result_df)
}
# define mapping of MINOR_AREA_CODEs to MINOR_BAY
minor_area_mapping <- list(
Copano_Bay = c(270, 317, 293, 120, 240, 310),
Aransas_Bay = c(227, 20, 13, 280, 285, 95, 94),
Mesquite_Bay = c(143, 70, 315, 250, 90)
)
# make initial df
AransasBay_Sciaenid_Wide <- data.frame(YEAR = character())
# use function to get values for 5 fish species from gill net surveys
AransasBay_Sciaenid_Wide <- processforDSEM(
data = AransasBay_GN_cpue,
species = c("HardheadCatfish", "GafftopsailCatfish", "RedDrum", "BlackDrum", "SpottedSeatrout"),
minor_area_mapping = minor_area_mapping,
date_column = "DATE",
result_df = AransasBay_Sciaenid_Wide
)
# use function to get values for brown shrimp from bag seine surveys
AransasBay_Sciaenid_Wide <- processforDSEM(
data = AransasBay_BS_shrimp,
species = c("BrownShrimp"),
minor_area_mapping = minor_area_mapping,
date_column = "DATE",
result_df = AransasBay_Sciaenid_Wide
)
# use function to get values for juvenile blue crabs from bag seine surveys
AransasBay_Sciaenid_Wide <- processforDSEM(
data = AransasBay_BS_bluecrabs,
species = c("BlueCrabSmall"),
minor_area_mapping = minor_area_mapping,
date_column = "DATE",
result_df = AransasBay_Sciaenid_Wide
)
# use function to get values for temp and salinity from all gill net, bag seine and bottom trawl surveys
AransasBay_Sciaenid_Wide <- processforDSEM(
data = AransasBay_Abiotics,
species = c("START_TEMPERATURE_NUM", "START_SALINITY_NUM"),
minor_area_mapping = minor_area_mapping,
date_column = "DATE",
result_df = AransasBay_Sciaenid_Wide
)
# the df now has all the needed data (I think?). we still need to transform/standardize the values, but first lets clean up the df (remove and rename some columns)
AransasBay_Sciaenid_Wide <- AransasBay_Sciaenid_Wide %>%
select(-BrownShrimp_NA, -START_TEMPERATURE_NUM_NA, -START_SALINITY_NUM_NA, -BlueCrabSmall_NA)
AransasBay_Sciaenid_Wide <- AransasBay_Sciaenid_Wide %>%
rename_with(
.fn = ~ gsub("^START_TEMPERATURE_NUM_", "Temperature_", .),
.cols = starts_with("START_TEMPERATURE_NUM_")
) %>%
rename_with(
.fn = ~ gsub("^START_SALINITY_NUM_", "Salinity_", .),
.cols = starts_with("START_SALINITY_NUM_")
)
# quick inspection of some temporal trends, using catfish because I have an idea of what these trends should look like based on zach's recent work
library(ggplot2)
time_series_data <- AransasBay_Sciaenid_Wide %>%
select(YEAR, starts_with("GafftopsailCatfish"), starts_with("HardheadCatfish")) %>%
pivot_longer(
cols = -YEAR,
names_to = c("Species", "Bay"),
names_sep = "_",  # Assumes the column names are in "Species_Bay" format
values_to = "Mean_CPUE"
)
ggplot(time_series_data, aes(x = YEAR, y = Mean_CPUE, color = Bay, group = interaction(Species, Bay))) +
geom_line(size = 1) +
geom_point(size = 2) +
facet_wrap(~ Species, scales = "free_y") +
labs(
title = "Time Series of Gafftopsail Catfish and Hardhead Catfish CPUE",
x = "Year",
y = "Mean CPUE",
color = "Bay"
) +
theme_bw() +
theme(
legend.position = "bottom",
plot.title = element_text(hjust = 0.5, size = 14),
axis.text.x = element_text(angle = 45, hjust = 1)
)
# remove spaces from column names
colnames(AransasBay_Sciaenid_Wide) <- gsub(" ", "", colnames(AransasBay_Sciaenid_Wide))
# okay now lets transform the values and create a new df
AransasBay_Sciaenid_Wide_Trans <- AransasBay_Sciaenid_Wide %>%
# Step 1: Apply log transformation
mutate(across(
.cols = where(is.numeric) & !contains("YEAR"),
.fns = ~ log(. + 1)  # Log transformation with a small shift to avoid log(0)
)) %>%
# Step 2: Apply standardization (mean = 0, SD = 1)
mutate(across(
.cols = where(is.numeric) & !contains("YEAR"),
.fns = ~ (. - mean(.)) / sd(.)
))
View(AransasBay_Sciaenid_Wide_Trans)
